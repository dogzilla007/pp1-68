<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบข้อมูลนักเรียน</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #fce4ec 0%, #e3f2fd 100%);
            /* Pink to Blue */
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: 600px;
            opacity: 0.08;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            /* Glass effect */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        h1 {
            text-align: center;
            font-size: 22px;
            color: #d81b60;
            /* Deep Pink */
            margin-top: 10px;
        }

        .logo-header {
            display: block;
            margin: 0 auto 10px auto;
            width: 100px;
            height: auto;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            background: #fff;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-login {
            background-color: #d81b60;
            /* School Pink */
            color: white;
        }

        .btn-confirm {
            background-color: #28a745;
            color: white;
        }

        .btn-edit-mode {
            background-color: #ffc107;
            color: black;
        }

        .btn-save {
            background-color: #dc3545;
            color: white;
        }

        .hidden {
            display: none;
        }

        .data-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .label {
            font-weight: bold;
            color: #555;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- Watermark Logo -->
    <img src="./assets/logo.png" class="watermark" alt="Watermark">

    <div class="container" id="loginBox">
        <img src="./assets/logo.png" class="logo-header" alt="Logo">
        <h1>เข้าสู่ระบบตรวจสอบข้อมูล<br><small style="font-size:16px; color:#666;">โรงเรียนเตรียมอุดมศึกษา
                ภาคตะวันออกเฉียงเหนือ</small></h1>
        <input type="text" id="userInput" placeholder="เลขประจำตัวประชาชน">
        <input type="password" id="passInput" placeholder="วันเดือนปีเกิด (เช่น 01022550)">
        <button class="btn-login" onclick="login()">เข้าสู่ระบบ</button>
        <div id="loginMsg" class="status"></div>
    </div>

    <!-- Summary Dashboard -->
    <div class="container" id="summaryBox" style="margin-top: 20px; max-width: 500px;">
        <h3>สรุปสถานะการตรวจสอบข้อมูล</h3>
        <div style="display:flex; justify-content:space-around; margin-bottom:15px;">
            <div style="text-align:center;">
                <h2 id="countVerified" style="color:green; margin:0;">0</h2>
                <small>ตรวจสอบแล้ว</small>
            </div>
            <div style="text-align:center; cursor:pointer; background:#fff0f0; padding:5px 10px; border-radius:8px;"
                onclick="openModal()">
                <h2 id="countPending" style="color:red; margin:0;">0</h2>
                <small>ยังไม่ตรวจสอบ (คลิกดู)</small>
            </div>
            <div style="text-align:center;">
                <h2 id="countTotal" style="color:blue; margin:0;">0</h2>
                <small>ทั้งหมด</small>
            </div>
        </div>
    </div>

    <!-- Modal for Pending List -->
    <div id="listModal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; display:none;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:80%; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:red;">รายชื่อผู้ทียังไม่ตรวจสอบข้อมูล</h3>
                <button onclick="closeModal()"
                    style="width:auto; margin:0; padding:0 10px; background:transparent; color:#333; font-size:24px; border:none; cursor:pointer;">&times;</button>
            </div>

            <div style="overflow-y:auto; flex-grow:1;">
                <table style="width:100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background:#eee; text-align:left; position: sticky; top: 0;">
                            <th style="padding:10px;">ชื่อ-สกุล</th>
                            <th style="padding:10px;">ชั้น/ห้อง</th>
                            <th style="padding:10px; text-align:center;">เลขที่</th>
                        </tr>
                    </thead>
                    <tbody id="modalListBody">
                        <!-- Content via JS -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button onclick="closeModal()"
                    style="width:auto; background:#6c757d; color:white; padding:8px 15px; border-radius:5px; border:none; cursor:pointer;">ปิด</button>
            </div>
        </div>
    </div>

    <div class="container hidden" id="dataBox">
        <h1>ข้อมูลส่วนตัว</h1>
        <div id="displayArea"></div>
        <div id="mainBtns">
            <button class="btn-confirm" onclick="action('confirm')">ข้อมูลถูกต้อง (ยืนยัน)</button>
            <button class="btn-edit-mode" onclick="toggleEdit(true)">ข้อมูลไม่ถูกต้อง (แก้ไข)</button>
        </div>
        <div id="editArea" class="hidden">
            <hr>
            <h3>แก้ไขข้อมูล</h3>
            <form id="editForm"></form>
            <button class="btn-save" onclick="action('edit')">บันทึกการแก้ไข</button>
            <button onclick="toggleEdit(false)">ยกเลิก</button>
        </div>
        <div id="actionMsg" class="status"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby863XelAplN3IoelQKfCySv-J9lGH3qD3Xd2tNWI0FyVXSe92oeB-KknIrx6zRkhdgXQ/exec';
        let studentData = {};

        const FIELDS = [
            { key: 'studentId', label: 'รหัสนักเรียน', edit: false },
            { key: 'user', label: 'เลขประชาชน', edit: false },
            { key: 'prefix', label: 'คำนำหน้า', edit: true },
            { key: 'firstname', label: 'ชื่อ', edit: true },
            { key: 'lastname', label: 'นามสกุล', edit: true },
            { key: 'class', label: 'ชั้น', edit: true },
            { key: 'room', label: 'ห้อง', edit: true },
            { key: 'ordinal', label: 'เลขที่', edit: true },
            { key: 'birthday', label: 'วันเดือนปีเกิด', edit: true },
            { key: 'sex', label: 'เพศ', edit: true },
            { key: 'nationality', label: 'เชื้อชาติ', edit: true },
            { key: 'religion', label: 'ศาสนา', edit: true },
            { key: 'school', label: 'โรงเรียนเดิม', edit: true },
            { key: 'province', label: 'จังหวัด', edit: true },
            { key: 'fatherPrefix', label: 'คำนำหน้าบิดา', edit: true },
            { key: 'fatherName', label: 'ชื่อบิดา', edit: true },
            { key: 'fatherSurname', label: 'นามสกุลบิดา', edit: true },
            { key: 'motherPrefix', label: 'คำนำหน้ามารดา', edit: true },
            { key: 'motherName', label: 'ชื่อมารดา', edit: true },
            { key: 'motherSurname', label: 'นามสกุลมารดา', edit: true }
        ];

        ;

        // Load Summary on Start
        // Global variable to store summary data
        let summaryData = { list: [] };

        // Load Summary on Start
        window.onload = fetchSummary;

        async function fetchSummary() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getSummary`);
                const data = await res.json();
                summaryData = data; // Store globally

                document.getElementById('countVerified').innerText = data.counts.verified;
                document.getElementById('countPending').innerText = data.counts.pending;
                document.getElementById('countTotal').innerText = data.counts.total;

            } catch (e) {
                console.error(e);
            }
        }

        function openModal() {
            const modal = document.getElementById('listModal');
            const tbody = document.getElementById('modalListBody');

            // Filter only Pending
            const pendingList = summaryData.list.filter(item => item.status !== 'เรียบร้อย');

            tbody.innerHTML = '';
            if (pendingList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:10px;">ไม่มีผู้ค้างตรวจสอบ</td></tr>`;
            } else {
                pendingList.forEach(item => {
                    const row = `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px;">${item.prefix}${item.firstname} ${item.lastname}</td>
                            <td style="padding:8px;">${item.class}/${item.room}</td>
                            <td style="padding:8px; text-align:center;">${item.ordinal || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Set display to flex to verify visible
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('listModal').classList.add('hidden');
            document.getElementById('listModal').style.display = 'none';
        }

        async function login() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            const msg = document.getElementById('loginMsg');

            msg.innerText = "กำลังค้นหา...";
            try {
                const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&password=${p}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                studentData = data;
                renderData();
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('dataBox').classList.remove('hidden');
            } catch (e) { msg.innerText = e.message; msg.style.color = 'red'; }
        }

        function renderData() {
            const area = document.getElementById('displayArea');
            const form = document.getElementById('editForm');
            area.innerHTML = ''; form.innerHTML = '';

            FIELDS.forEach(f => {
                area.innerHTML += `<div class="data-item"><span class="label">${f.label}:</span> <span>${studentData[f.key] || '-'}</span></div>`;
                if (f.edit) {
                    form.innerHTML += `<label>${f.label}</label><input type="text" name="${f.key}" value="${studentData[f.key] || ''}">`;
                }
            });
        }

        function toggleEdit(show) {
            document.getElementById('editArea').classList.toggle('hidden', !show);
            document.getElementById('mainBtns').classList.toggle('hidden', show);
        }

        async function action(type) {
            if (!confirm('ยืนยันการทำรายการ?')) return;
            const msg = document.getElementById('actionMsg');
            msg.innerText = "กำลังบันทึก...";

            const formData = new URLSearchParams();
            formData.append('action', type);
            formData.append('rowIndex', studentData.rowIndex); // ส่งเลขแถวกลับไป
            // Add these so it works even if the backend is the old version
            formData.append('user', studentData.user);
            formData.append('password', studentData.password);

            if (type === 'edit') {
                const inputs = document.getElementById('editForm').elements;
                for (let i = 0; i < inputs.length; i++) {
                    formData.append(inputs[i].name, inputs[i].value);
                }
            }

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.text();
                if (result.includes("Updated") || result.includes("Success")) {
                    alert("ดำเนินการสำเร็จ");
                    // Hide buttons to prevent re-submission
                    document.getElementById('mainBtns').classList.add('hidden');
                    document.getElementById('editArea').classList.add('hidden');

                    // Show success message permanently
                    msg.innerText = "บันทึกข้อมูลเรียบร้อยแล้ว (ไม่สามารถแก้ไขได้อีก)";
                    msg.style.color = "green";
                } else throw new Error(result);
            } catch (e) { msg.innerText = e.message; msg.style.color = 'red'; }
        }
    </script>
</body>

</html>
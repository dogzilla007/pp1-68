<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบข้อมูลนักเรียน</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #fce4ec 0%, #e3f2fd 100%);
            /* Pink to Blue */
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: 600px;
            opacity: 0.08;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            /* Glass effect */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        h1 {
            text-align: center;
            font-size: 22px;
            color: #d81b60;
            /* Deep Pink */
            margin-top: 10px;
        }

        .logo-header {
            display: block;
            margin: 0 auto 10px auto;
            width: 100px;
            height: auto;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            background: #fff;
        }

        input:disabled {
            background-color: #f0f0f0;
            /* Light Gray */
            color: #666;
            cursor: not-allowed;
            border-color: #ccc;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-login {
            background-color: #d81b60;
            /* School Pink */
            color: white;
        }

        .btn-confirm {
            background-color: #28a745;
            color: white;
        }

        .btn-edit-mode {
            background-color: #ffc107;
            color: black;
        }

        .btn-save {
            background-color: #dc3545;
            color: white;
        }

        .hidden {
            display: none;
        }

        .data-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .label {
            font-weight: bold;
            color: #555;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- Watermark Logo -->
    <img src="./assets/logo.png" class="watermark" alt="Watermark">

    <div class="container" id="loginBox">
        <img src="./assets/logo.png" class="logo-header" alt="Logo">
        <h1>เข้าสู่ระบบตรวจสอบข้อมูล<br><small style="font-size:16px; color:#666;">โรงเรียนเตรียมอุดมศึกษา
                ภาคตะวันออกเฉียงเหนือ</small></h1>
        <input type="text" id="userInput" placeholder="เลขประจำตัวประชาชน">
        <input type="password" id="passInput" placeholder="วันเดือนปีเกิด (เช่น 01022550)">
        <button class="btn-login" onclick="login()">เข้าสู่ระบบ</button>
        <div id="loginMsg" class="status"></div>
    </div>

    <!-- Summary Dashboard -->
    <div class="container" id="summaryBox" style="margin-top: 20px; max-width: 500px;">
        <h3>สรุปสถานะการตรวจสอบข้อมูล</h3>
        <div style="display:flex; justify-content:space-around; margin-bottom:15px;">
            <div style="text-align:center;">
                <h2 id="countVerified" style="color:green; margin:0;">0</h2>
                <small>ตรวจสอบแล้ว</small>
            </div>
            <div style="text-align:center; cursor:pointer; background:#fff0f0; padding:5px 10px; border-radius:8px;"
                onclick="openModal()">
                <h2 id="countPending" style="color:red; margin:0;">0</h2>
                <small>ยังไม่ตรวจสอบ (คลิกดู)</small>
            </div>
            <div style="text-align:center;">
                <h2 id="countTotal" style="color:blue; margin:0;">0</h2>
                <small>ทั้งหมด</small>
            </div>
        </div>
    </div>

    <!-- Modal for Pending List -->
    <div id="listModal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; display:none;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:80%; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:red;">รายชื่อผู้ทียังไม่ตรวจสอบข้อมูล</h3>
                <button onclick="closeModal()"
                    style="width:auto; margin:0; padding:0 10px; background:transparent; color:#333; font-size:24px; border:none; cursor:pointer;">&times;</button>
            </div>

            <div style="overflow-y:auto; flex-grow:1;">
                <table style="width:100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background:#eee; text-align:left; position: sticky; top: 0;">
                            <th style="padding:10px;">ชื่อ-สกุล</th>
                            <th style="padding:10px;">ชั้น/ห้อง</th>
                            <th style="padding:10px; text-align:center;">เลขที่</th>
                        </tr>
                    </thead>
                    <tbody id="modalListBody">
                        <!-- Content via JS -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button onclick="closeModal()"
                    style="width:auto; background:#6c757d; color:white; padding:8px 15px; border-radius:5px; border:none; cursor:pointer;">ปิด</button>
            </div>
        </div>
    </div>

    <div class="container hidden" id="dataBox" style="position:relative;">
        <button onclick="logout()"
            style="position:absolute; top:20px; right:20px; width:auto; background:#dc3545; color:white; padding:5px 15px; font-size:14px; border-radius:20px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">ออกจากระบบ</button>
        <h1>ข้อมูลส่วนตัว</h1>
        <div id="displayArea"></div>

        <!-- Phone Number Section -->
        <div id="phoneInputs" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3 style="color:#d81b60;">ข้อมูลติดต่อ (จำเป็นต้องระบุ)</h3>

            <label style="font-weight:bold;">เบอร์โทรศัพท์นักเรียน <span style="color:red;">*</span></label>
            <input type="tel" id="studentPhone" placeholder="กรอกเบอร์โทรศัพท์นักเรียน (10 หลัก)" maxlength="10"
                oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>

            <label style="font-weight:bold;">เบอร์โทรศัพท์ผู้ปกครอง <span style="color:red;">*</span></label>
            <input type="tel" id="guardianPhone" placeholder="กรอกเบอร์โทรศัพท์ผู้ปกครอง (10 หลัก)" maxlength="10"
                oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
        </div>

        <div id="mainBtns">
            <button class="btn-confirm" onclick="action('confirm')">ข้อมูลถูกต้อง (ยืนยัน)</button>
            <button class="btn-edit-mode" onclick="toggleEdit(true)">ข้อมูลไม่ถูกต้อง (แก้ไข)</button>
        </div>
        <div id="editArea" class="hidden">
            <hr>
            <h3>แก้ไขข้อมูล</h3>
            <form id="editForm"></form>
            <button class="btn-save" onclick="action('edit')">บันทึกการแก้ไข</button>
            <button onclick="toggleEdit(false)">ยกเลิก</button>
        </div>
        <div id="actionMsg" class="status"></div>
    </div>

    <!-- Post-Login Instruction Modal -->
    <div id="instructionModal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; display:none;">
        <div
            style="background:white; padding:30px; border-radius:15px; width:90%; max-width:600px; text-align:center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="color:#d81b60; margin-bottom:20px;">คำชี้แจงสำคัญ</h2>
            <div style="font-size:18px; line-height:1.6; color:#333; margin-bottom:25px;">
                โปรดตรวจสอบตัวสะกด ชื่อ-นามสกุล และข้อมูลอื่นๆ ให้ถูกต้องสมบูรณ์ที่สุด<br>
                เพื่อนำไปใช้ในการจัดทำเอกสารจบการศึกษา (ปพ.1)

                <div
                    style="margin-top:20px; padding:15px; background:#ffebee; border:2px solid #ffcdd2; border-radius:10px;">
                    <strong style="color:red; font-size:20px; display:block; margin-bottom:5px;">ข้อควรระวัง!</strong>
                    <span style="color:#d32f2f; font-weight:bold;">
                        ข้อมูล ชื่อ-นามสกุล ของบิดาและมารดา<br>
                        "ต้องเป็นผู้ให้กำเนิดตามสูติบัตรเท่านั้น"
                    </span>
                </div>
            </div>
            <button onclick="closeInstructionModal()"
                style="background:#28a745; color:white; padding:12px 30px; font-size:16px; border-radius:30px; border:none; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                รับทราบและตรวจสอบข้อมูล
            </button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby863XelAplN3IoelQKfCySv-J9lGH3qD3Xd2tNWI0FyVXSe92oeB-KknIrx6zRkhdgXQ/exec';
        let studentData = {};

        const FIELDS = [
            { key: 'studentId', label: 'รหัสนักเรียน', edit: false },
            { key: 'user', label: 'เลขประชาชน', edit: false },
            { key: 'prefix', label: 'คำนำหน้า', edit: true },
            { key: 'firstname', label: 'ชื่อ', edit: true },
            { key: 'lastname', label: 'นามสกุล', edit: true },
            { key: 'class', label: 'ชั้น', edit: true },
            { key: 'room', label: 'ห้อง', edit: true },
            { key: 'ordinal', label: 'เลขที่', edit: true },
            { key: 'birthday', label: 'วันเดือนปีเกิด', edit: true },
            { key: 'sex', label: 'เพศ', edit: true },
            { key: 'nationality', label: 'เชื้อชาติ', edit: true },
            { key: 'religion', label: 'ศาสนา', edit: true },
            { key: 'school', label: 'โรงเรียนเดิม', edit: true },
            { key: 'province', label: 'จังหวัด', edit: true },
            { key: 'fatherPrefix', label: 'คำนำหน้าบิดา', edit: true },
            { key: 'fatherName', label: 'ชื่อบิดา', edit: true },
            { key: 'fatherSurname', label: 'นามสกุลบิดา', edit: true },
            { key: 'motherPrefix', label: 'คำนำหน้ามารดา', edit: true },
            { key: 'motherName', label: 'ชื่อมารดา', edit: true },
            { key: 'motherSurname', label: 'นามสกุลมารดา', edit: true }
        ];

        ;

        // Load Summary on Start
        // Global variable to store summary data
        let summaryData = { list: [] };

        // Load Summary on Start
        window.onload = fetchSummary;

        async function fetchSummary() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getSummary`);
                const data = await res.json();
                summaryData = data; // Store globally

                document.getElementById('countVerified').innerText = data.counts.verified;
                document.getElementById('countPending').innerText = data.counts.pending;
                document.getElementById('countTotal').innerText = data.counts.total;

            } catch (e) {
                console.error(e);
            }
        }

        function openModal() {
            const modal = document.getElementById('listModal');
            const tbody = document.getElementById('modalListBody');

            // Filter only Pending
            const pendingList = summaryData.list.filter(item => item.status !== 'เรียบร้อย');

            tbody.innerHTML = '';
            if (pendingList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:10px;">ไม่มีผู้ค้างตรวจสอบ</td></tr>`;
            } else {
                pendingList.forEach(item => {
                    const row = `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px;">${item.prefix}${item.firstname} ${item.lastname}</td>
                            <td style="padding:8px;">${item.class}/${item.room}</td>
                            <td style="padding:8px; text-align:center;">${item.ordinal || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Set display to flex to verify visible
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('listModal').classList.add('hidden');
            document.getElementById('listModal').style.display = 'none';
        }

        function closeInstructionModal() {
            const modal = document.getElementById('instructionModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            // Show data box after closing instruction
            document.getElementById('dataBox').classList.remove('hidden');
        }

        async function login() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            const msg = document.getElementById('loginMsg');

            msg.innerText = "กำลังค้นหา...";
            try {
                const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&password=${p}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                studentData = data;

                // Save Session
                localStorage.setItem('studentData', JSON.stringify(studentData));

                renderData();
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('summaryBox').classList.add('hidden'); // Hide Summary

                // Show Instruction Modal instead of direct Data Box
                const instModal = document.getElementById('instructionModal');
                instModal.style.display = 'flex';
                instModal.classList.remove('hidden');

                // Check status before showing
                checkStatusAndSetupUI();
            } catch (e) { msg.innerText = e.message; msg.style.color = 'red'; }
        }

        function checkStatusAndSetupUI() {
            const hasStatus = studentData.status && String(studentData.status).trim() !== "";

            if (hasStatus) {
                // Already Verified/Edited
                document.getElementById('mainBtns').classList.add('hidden');

                // Disable phone inputs
                document.getElementById('studentPhone').disabled = true;
                document.getElementById('guardianPhone').disabled = true;

                // Show Status Message
                const msgDiv = document.getElementById('actionMsg');
                let statusText = `ท่านได้ทำรายการเรียบร้อยแล้ว (${studentData.status})`;

                // Add Re-edit button (Subtle Style)
                statusText += `<br><br><small onclick="enableReEdit()" style="color:#bbb; font-size:11px; cursor:pointer; text-decoration:underline;">ขอแก้ไขข้อมูลอีกครั้ง</small>`;

                msgDiv.innerHTML = statusText;
                msgDiv.style.color = "green";
                msgDiv.style.textAlign = "center";
                msgDiv.style.fontWeight = "bold";
            } else {
                // Not yet verified
                document.getElementById('mainBtns').classList.remove('hidden');
                document.getElementById('actionMsg').innerHTML = "";
            }
        }

        function enableReEdit() {
            if (!confirm("คุณต้องการแก้ไขข้อมูลอีกครั้งใช่หรือไม่?")) return;

            // Enable buttons and inputs
            // Instead of showing mainBtns (Green/Yellow), go straight to Edit Mode
            toggleEdit(true);

            document.getElementById('studentPhone').disabled = false;
            document.getElementById('guardianPhone').disabled = false;

            // Clear status message
            document.getElementById('actionMsg').innerHTML = "";
            document.getElementById('actionMsg').innerText = "กรุณาแก้ไขข้อมูลให้ถูกต้อง แล้วกดบันทึก";
            document.getElementById('actionMsg').style.color = "#d81b60";
        }

        function renderData() {
            const area = document.getElementById('displayArea');
            const form = document.getElementById('editForm');
            area.innerHTML = ''; form.innerHTML = '';

            let areaHtml = "";

            FIELDS.forEach(f => {
                let displayValue = studentData[f.key] || '-';
                let editHtml = "";

                // Check for requested edits (from Col Z+)
                // Only show if different and not empty
                if (studentData["edit_" + f.key]) {
                    let editVal = studentData["edit_" + f.key];

                    // Compare raw string value with original value (since backend now returns display values)
                    if (String(editVal).trim() !== String(studentData[f.key] || "").trim()) {
                        editHtml = `<br><span style="color:red; font-size:0.9em;">(ขอแก้ไขเป็น: ${editVal})</span>`;
                    }
                }

                // Add Red Frame Start for Parent Info
                if (f.key === 'fatherPrefix') {
                    areaHtml += `<div style="border: 2px solid red; padding: 15px; border-radius: 8px; margin: 20px 0; background-color: #fff5f5;">
                                    <h3 style="color:#d32f2f; margin-top:0; border-bottom:1px solid #ffcdd2; padding-bottom:10px;">ข้อมูลบิดา-มารดา <span style="color:red; font-size:0.6em;">*ตามสูติบัตร</span></h3>`;
                }

                areaHtml += `<div class="data-item">
                                        <span class="label">${f.label}:</span> 
                                        <div style="text-align:right;">
                                            <span>${displayValue}</span>
                                            ${editHtml}
                                        </div>
                                   </div>`;

                // Add Red Frame End after Mother Info
                if (f.key === 'motherSurname') {
                    areaHtml += `</div>`;
                }

                if (f.edit) {
                    let val = studentData["edit_" + f.key] || studentData[f.key] || '';
                    form.innerHTML += `<label>${f.label}</label><input type="text" name="${f.key}" value="${val}">`;
                }
            });

            area.innerHTML = areaHtml;
            // Pre-fill phone numbers if available in studentData (assuming backend returns them)
            if (studentData.studentPhone) document.getElementById('studentPhone').value = studentData.studentPhone;
            if (studentData.guardianPhone) document.getElementById('guardianPhone').value = studentData.guardianPhone;
        }

        function toggleEdit(show) {
            const editArea = document.getElementById('editArea');
            const mainBtns = document.getElementById('mainBtns');

            if (show) {
                editArea.classList.remove('hidden');
                mainBtns.classList.add('hidden');
            } else {
                editArea.classList.add('hidden');
                // Check if already verified/pending
                if (studentData.status) {
                    mainBtns.classList.add('hidden');
                    checkStatusAndSetupUI(); // Re-show status message
                } else {
                    mainBtns.classList.remove('hidden');
                }
            }
        }

        async function action(type) {
            // Validate Phone Numbers
            const sPhone = document.getElementById('studentPhone').value.trim();
            const gPhone = document.getElementById('guardianPhone').value.trim();

            if (!sPhone || !gPhone || sPhone.length !== 10 || gPhone.length !== 10) {
                alert("กรุณากรอกเบอร์โทรศัพท์ให้ครบ 10 หลัก (เฉพาะตัวเลข)");
                // Highlight inputs
                if (!sPhone || sPhone.length !== 10) document.getElementById('studentPhone').style.border = "2px solid red";
                if (!gPhone || gPhone.length !== 10) document.getElementById('guardianPhone').style.border = "2px solid red";
                return;
            } else {
                // Reset styles
                document.getElementById('studentPhone').style.border = "1px solid #ddd";
                document.getElementById('guardianPhone').style.border = "1px solid #ddd";
            }

            if (!confirm('ยืนยันการทำรายการ?')) return;
            const msg = document.getElementById('actionMsg');
            msg.innerText = "กำลังบันทึก...";

            const formData = new URLSearchParams();
            formData.append('action', type);
            formData.append('rowIndex', studentData.rowIndex); // ส่งเลขแถวกลับไป
            // Add these so it works even if the backend is the old version
            formData.append('user', studentData.user);
            formData.append('password', studentData.password);

            // Append Phone Numbers
            formData.append('studentPhone', sPhone);
            formData.append('guardianPhone', gPhone);

            if (type === 'edit') {
                const inputs = document.getElementById('editForm').elements;
                for (let i = 0; i < inputs.length; i++) {
                    formData.append(inputs[i].name, inputs[i].value);
                }
            }

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const result = await res.text();
                // Check for success message from backend
                if (result.includes("Updated") || result.includes("Success")) {
                    alert("ดำเนินการสำเร็จ");
                    // Hide buttons to prevent re-submission
                    document.getElementById('mainBtns').classList.add('hidden');
                    document.getElementById('editArea').classList.add('hidden');

                    // Disable phone inputs
                    document.getElementById('studentPhone').disabled = true;
                    document.getElementById('guardianPhone').disabled = true;

                    // Show success message permanently
                    msg.innerText = "บันทึกข้อมูลเรียบร้อยแล้ว";
                    msg.style.color = "green";

                    // Update Local Data immediately for UI refresh
                    studentData.status = (type === 'edit') ? "ขอแก้ไข - ล่าสุด" : "ยืนยันแล้ว - ล่าสุด";
                    studentData.studentPhone = sPhone;
                    studentData.guardianPhone = gPhone;

                    if (type === 'edit') {
                        const inputs = document.getElementById('editForm').elements;
                        for (let i = 0; i < inputs.length; i++) {
                            if (inputs[i].name) {
                                studentData["edit_" + inputs[i].name] = inputs[i].value;
                            }
                        }
                    }

                    // Update Storage
                    localStorage.setItem('studentData', JSON.stringify(studentData));

                    // Re-render data to show red parenthesis immediately
                    renderData();

                    // Refresh status logic to show 'Re-edit' button immediately
                    setTimeout(() => checkStatusAndSetupUI(), 500);
                } else throw new Error(result);
            } catch (e) { msg.innerText = e.message; msg.style.color = 'red'; }
        }

        function logout() {
            if (confirm("ต้องการออกจากระบบ?")) {
                localStorage.removeItem('studentData');
                location.reload();
            }
        }

        function checkSession() {
            const stored = localStorage.getItem('studentData');
            if (stored) {
                try {
                    studentData = JSON.parse(stored);
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('summaryBox').classList.add('hidden'); // Hide Summary
                    document.getElementById('dataBox').classList.remove('hidden');

                    renderData();
                    checkStatusAndSetupUI();
                } catch (e) {
                    localStorage.removeItem('studentData');
                }
            }
        }

        // Run on load
        window.onload = function () {
            checkSession();
            // If not logged in (loginBox is visible), fetch summary
            if (!localStorage.getItem('studentData')) {
                fetchSummary();
            }
        };
    </script>
</body>

</html>